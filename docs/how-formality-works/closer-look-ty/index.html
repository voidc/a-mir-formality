<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-how-formality-works/closer-look-ty">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/a-mir-formality/blog/rss.xml" title="a-mir-formality RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/a-mir-formality/blog/atom.xml" title="a-mir-formality Atom Feed"><title data-rh="true">A closer look at `formality-ty` | a-mir-formality</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nikomatsakis.github.io/a-mir-formality/a-mir-formality/docs/how-formality-works/closer-look-ty"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="A closer look at `formality-ty` | a-mir-formality"><meta data-rh="true" name="description" content="Let&#x27;s take a closer look at the formality-ty layer."><meta data-rh="true" property="og:description" content="Let&#x27;s take a closer look at the formality-ty layer."><link data-rh="true" rel="icon" href="/a-mir-formality/img/ferris.svg"><link data-rh="true" rel="canonical" href="https://nikomatsakis.github.io/a-mir-formality/a-mir-formality/docs/how-formality-works/closer-look-ty"><link data-rh="true" rel="alternate" href="https://nikomatsakis.github.io/a-mir-formality/a-mir-formality/docs/how-formality-works/closer-look-ty" hreflang="en"><link data-rh="true" rel="alternate" href="https://nikomatsakis.github.io/a-mir-formality/a-mir-formality/docs/how-formality-works/closer-look-ty" hreflang="x-default"><link rel="stylesheet" href="/a-mir-formality/assets/css/styles.0af99b86.css">
<link rel="preload" href="/a-mir-formality/assets/js/runtime~main.195de727.js" as="script">
<link rel="preload" href="/a-mir-formality/assets/js/main.e2be71f9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/a-mir-formality/"><div class="navbar__logo"><img src="/a-mir-formality/img/ferris.svg" alt="a-mir-formality logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/a-mir-formality/img/ferris.svg" alt="a-mir-formality logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title text--truncate">a-mir-formality</b></a><a class="navbar__item navbar__link navbar__link--active" href="/a-mir-formality/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/a-mir-formality/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/a-mir-formality/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/a-mir-formality/docs/setup">Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/a-mir-formality/docs/category/how-formality-works">How formality works</a><button aria-label="Toggle the collapsible sidebar category &#x27;How formality works&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/a-mir-formality/docs/how-formality-works/layers">Layers of Formality</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/a-mir-formality/docs/how-formality-works/closer-look-ty">A closer look at `formality-ty`</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/a-mir-formality/docs/how-formality-works/closer-look-decl">A closer look at `formality-decl`</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/a-mir-formality/docs/category/what-formality-can-do">What formality can do</a><button aria-label="Toggle the collapsible sidebar category &#x27;What formality can do&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/a-mir-formality/docs/conventions">Conventions</a></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/a-mir-formality/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/a-mir-formality/docs/category/how-formality-works"><span itemprop="name">How formality works</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">A closer look at `formality-ty`</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_bZGK theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_l22C">On this page</button></div><div class="theme-doc-markdown markdown"><h1>A closer look at <code>formality-ty</code></h1><p>Let&#x27;s take a closer look at the <code>formality-ty</code> layer.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="defining-rust-types">Defining Rust types<a class="hash-link" href="#defining-rust-types" title="Direct link to heading">​</a></h3><p>The current definition of types looks like this:</p><div class="language-scheme codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">(define-language formality-ty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (Ty :=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (rigid-ty TyName Parameters) ; Application type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      VarId                        ; Bound or existential (inference) variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (! VarId)                    ; Universal (placeholder) variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (TyName :=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AdtId           ; enum/struct/union</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          TraitId         ; trait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AssociatedTy    ; Associated type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ScalarId        ; Something like i32, u32, etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          (ref MaybeMut)  ; `&amp;mut` or `&amp;`, expects a lifetime + type parameter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          (tuple number)  ; tuple of given arity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (ScalarId := i8 u8 i16 u16 i32 u32 i64 u64 i128 u128 bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (AssociatedTy := (TraitId AssociatedTyId))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (Parameters := (Parameter ...))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (Parameter := Ty Lt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ((AdtId VarId TraitId AssociatedTyId AnyId) := variable-not-otherwise-mentioned)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><span class="caption">[Source](https://github.com/nikomatsakis/a-mir-formality/blob/47eceea34b5f56a55d781acc73dca86c996b15c5/src/ty/grammar.rkt#L25-L37)</span><p>This definition is far from complete,
but it should give you some idea for the level of abstraction we are shooting for
and also how PLT Redex works.
The idea here is that a type is either a variable,
a placeholder that represents a generic type,
or an &quot;application&quot; of a type name to some parameters.
Let&#x27;s see some examples:</p><ul><li>A generic type like <code>T</code> could either be <code>T</code> or <code>(! T)</code>:<ul><li><code>T</code> is used when the generic has yet to be substituted, e.g., as part of a declaration.</li><li><code>(! T)</code> is used as a placeholder to &quot;any type <code>T</code>&quot;.</li></ul></li><li>A type like <code>Vec&lt;T&gt;</code> in Rust would be represented therefore as:<ul><li><code>(rigid-ty Vec (T))</code>, in a declaration; or,</li><li><code>(rigid-ty Vec ((! T)))</code> when checking it.</li></ul></li><li>A scalar type like <code>i32</code> is represented as <code>(rigid-ty i32 ())</code>.</li></ul><p>As I said, this defintion of types is woefully incomplete. I expect it to eventually include:</p><ul><li>&quot;alias types&quot; like associated types and type aliases</li><li>&quot;existential&quot; types like <code>dyn</code></li><li>&quot;forall&quot; quantifies to cover <code>for&lt;&#x27;a&gt; ...</code></li><li>&quot;function&quot; types <code>fn(A1...An) -&gt; R</code></li><li>&quot;implication&quot; types <code>where(...) T</code> (these don&#x27;t exist in Rust—yet)</li></ul><p>You can also see that the definition of types is aligned to highlight their &quot;essential&quot; characteristics
and not necessarily for convenience elsewhere.
Almost every Rust type, for example, boils down to <em>some</em> kind of &quot;application&quot;
(it&#x27;s likely that we can even represent <code>fn</code> types this way).</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="type-unification">Type unification<a class="hash-link" href="#type-unification" title="Direct link to heading">​</a></h3><p>A key part of the type layer is that it includes <em>type unification</em>.
That is, it defines the rules for making types equal.
This will eventually have to be extended to cover subtyping (more on that a bit later)
so that we can properly handle variance.</p><p>Unification is accomplished in PLT Redex with a &quot;<a href="https://docs.racket-lang.org/redex/reference.html#%28form._%28%28lib._redex%2Freduction-semantics..rkt%29._define-metafunction%29%29" target="_blank" rel="noopener noreferrer">metafunction</a>&quot;,
which just means a function that operates on terms
(versus a function in the Rust program being analyzed):</p><div class="language-scheme codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">(define-metafunction formality-ty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  most-general-unifier : Env TermPairs -&gt; EnvSubstitution or Error</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function takes an environment <code>Env</code> and a list of pairs of terms that should be equated and gives back either:</p><ul><li>a new environment and substitution from inference variables to values that will make the two terms syntactically equal; or,</li><li>the term <code>Error</code>, if they cannot be unified.</li></ul><p>The unifier is a bit smarter than the traditional unification
in that it knows about <em>universes</em> and so can handle &quot;forall&quot; proofs and things
(that&#x27;s what is found in the environment).
This is the same as chalk and rustc.</p><p>I won&#x27;t cover the details but I&#x27;ll just give an example.
This is actually modified from a unit test from the code
(<a href="https://github.com/nikomatsakis/a-mir-formality/blob/47eceea34b5f56a55d781acc73dca86c996b15c5/src/ty/unify.rkt#L254-L269" target="_blank" rel="noopener noreferrer">source</a>).
Invoking <code>most-general-unifier</code> like so:</p><div class="language-scheme codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">(most-general-unifier Env_2 ((A X)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             (X (rigid-ty Vec (Y)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             (Y (rigid-ty i32 ()))))</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>corresponds to saying that <code>[A = X, X = Vec&lt;Y&gt;, Y = i32]</code> must all be true,
where <code>A</code>, <code>X</code> and <code>Y</code> are inference variables.
The resulting output is a substitution that maps <code>A</code>, <code>X</code>, and <code>Y</code> to the following values:</p><ul><li><code>A -&gt; Vec&lt;i32&gt;</code></li><li><code>X -&gt; Vec&lt;i32&gt;</code></li><li><code>Y -&gt; i32</code></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="predicates">Predicates<a class="hash-link" href="#predicates" title="Direct link to heading">​</a></h3><p><code>formality-ty</code> also defines the core predicates used to define Rust semantics.
The current definition is as follows:</p><div class="language-scheme,ignore codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme,ignore codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">{{#include ../../src/ty/grammar.rkt:Predicates}}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These core predicates are then used to define a richer vocabulary of goals (things that can be proven)
and various kinds of &quot;clauses&quot; (things that are assumed to be true, axioms):</p><div class="language-scheme,ignore codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme,ignore codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">{{#include ../../src/logic/grammar.rkt:GoalsAndHypotheses}}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Importantly, the <em>types layer</em> defines a solver that gives semantics to all the &quot;meta&quot; parts of goals and clauses -- e.g., it defines what it means to prove <code>(&amp;&amp; (G1 G2))</code> (prove both <code>G1</code> and <code>G2</code>, duh). But it doesn&#x27;t have any rules for what it means to prove the <em>core</em> predicates true -- so it could never prove <code>(is-implemented (Debug ((! T))))</code>. Those rules all come from the declaration layer and are given to the types layer as part of the &quot;environment&quot;.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="goals-versus-clauses">Goals versus clauses<a class="hash-link" href="#goals-versus-clauses" title="Direct link to heading">​</a></h4><p>You might be curious about the distinction between goal and clause
and why there are so many names for clauses (hypothesis, clause, invariant, etc).
Let&#x27;s talk briefly about that.</p><p>The role of <code>∀</code> in goals and clauses is different.
Proving <!-- -->\<!-- -->( \forall X. G <!-- -->\<!-- -->) requires proving that <code>G</code> is true for any value of <code>X</code>
(i.e., for a placeholder <code>(! X)</code>, in our setup).
By contrast, if you know <!-- -->\<!-- -->( \forall X. G <!-- -->\<!-- -->) as an axiom,
it means that you can give <code>X</code> any value <code>X1</code> you want.
Clauses have a limited structure between that keeps the solver tractable.
The idea is that they are always &quot;ways to prove a single predicate&quot; true;
we don&#x27;t allow a clause like <code>(|| (A B))</code> as a clause,
since that would mean &quot;A or B is true but you don&#x27;t know which&quot;.
That would then be a second way to prove an <code>||</code> goal like <code>(|| ...)</code>
and introduce lots of complications (we got enough already, thanks).</p><p>Further distinctions between &quot;hypotheses&quot;, &quot;clauses&quot;, and &quot;invariants&quot;
are used to express and capture implied bounds.
We&#x27;ll defer a detailed analysis until the section below, but briefly:</p><ul><li>&quot;Hypotheses&quot; are where-clauses that are assumed to be true in this section of the code.</li><li>&quot;Clauses&quot; are global rules that are always true (derived, e.g., from an impl).</li><li>&quot;Invariants&quot; express implied bounds (e.g., supertrait relationships like &quot;if <code>T: Eq</code>, then <code>T: PartialEq</code>&quot;).</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="solver">Solver<a class="hash-link" href="#solver" title="Direct link to heading">​</a></h3><p>Putting all this together, the types layer currently includes a relatively simple solver called <code>cosld-solve</code>.
The name refers to the classic <a href="https://en.wikipedia.org/wiki/SLD_resolution" target="_blank" rel="noopener noreferrer">SLD Resolution Algorithm</a> that powers Prolog,
although the version of it that we&#x27;ve implemented is extended in two ways:</p><ul><li>It is coinductive (hence <code>cosld</code>) as <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.102.9618&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener noreferrer">described by Luke Simon et al.</a>.
This means it permits cycles, roughly speaking.</li><li>It covers hereditary Harrop predicates using the <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.107.2510&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener noreferrer">techniques described by Gopalan Nadathur</a>.</li></ul><p>In terms of chalk solvers, it is &quot;similar&quot; to slg, but much simpler in its structure (it doesn&#x27;t do any caching).</p><p>All those fancy words aside, it&#x27;s really quite simple.
It&#x27;s defined via induction rules, which PLT Redex lets us write in a natural style with <a href="https://docs.racket-lang.org/redex/reference.html#%28form._%28%28lib._redex%2Freduction-semantics..rkt%29._define-judgment-form%29%29" target="_blank" rel="noopener noreferrer"><code>define-judgment-form</code></a>.
The definition begins like so:</p><div class="language-scheme codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">(define-judgment-form formality-ty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #:mode (prove I I I O)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #:contract (prove Env Predicates_stack Goal EnvSubstitution)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This says that we are trying to prove something written as <code>(prove Env Predciates Goal EnvSubstitution)</code>,
where the first three are &#x27;inputs&#x27; and the final name is an &#x27;output&#x27;
(the input vs output distinction is often left implicit in Prolog and other languages).
The idea is that we will prove that <code>Goal</code> is true in some environment <code>Env</code>;
the environment contains our hypotheses and clauses, as well as information about the variables in scope.
The <code>Predicates</code> list is the stack of things we are solving, it&#x27;s used to detect cycles.
The <code>EnvSubstitution</code> is the <em>output</em>, it is a modified environment
paired with a substitution that potentially gives new values to inference variables found in <code>Goal</code>.</p><p>Here is a simple rule.
It defines the way we prove <code>||</code> (<a href="https://github.com/nikomatsakis/a-mir-formality/blob/main/src/ty/cosld-solve/prove.rkt#L62-L65" target="_blank" rel="noopener noreferrer">source</a>).
The notation is as follows.
The stuff &quot;above the line&quot; are the conditions that have to be proven;
the thing &quot;under the line&quot; is the conclusion that we can draw.</p><div class="language-scheme codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-scheme codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">  [(prove Env Predicates_stack Goal_1 EnvSubstitution_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ------------------------------------------------------- &quot;prove-any&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (prove Env Predicates_stack (|| (Goal_0 ... Goal_1 Goal_2 ...)) EnvSubstitution_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This rule says:</p><ul><li>Given some goal <code>(|| (Goal_0 ... Goal_1 Goal_2 ...))</code> where <code>Goal_1</code> is found somewhere in that list...<ul><li>if we can prove <code>Goal_1</code> to be true, then the <code>||</code> goal is true.</li></ul></li></ul><p>Or read another way:</p><ul><li>If we can prove <code>Goal_1</code> to be true, then we can prove <code>(|| Goals)</code> to be true so long as <code>Goal_1</code> is somewhere in <code>Goals</code>.</li></ul><p>It shows you a bit of the power of PLT Redex (and Racket&#x27;s pattern matching), as well. We are able to write the rule in a &quot;non-deterministic&quot; way -- saying, &quot;pick any goal from the list&quot; and prove it. Redex will search all the possibilities.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/how-formality-works/closer-look-ty.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/a-mir-formality/docs/how-formality-works/layers"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Layers of Formality</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/a-mir-formality/docs/how-formality-works/closer-look-decl"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">A closer look at `formality-decl`</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#defining-rust-types" class="table-of-contents__link toc-highlight">Defining Rust types</a></li><li><a href="#type-unification" class="table-of-contents__link toc-highlight">Type unification</a></li><li><a href="#predicates" class="table-of-contents__link toc-highlight">Predicates</a></li><li><a href="#solver" class="table-of-contents__link toc-highlight">Solver</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/a-mir-formality/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/a-mir-formality/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 a-mir-formality contributors</div></div></div></footer></div>
<script src="/a-mir-formality/assets/js/runtime~main.195de727.js"></script>
<script src="/a-mir-formality/assets/js/main.e2be71f9.js"></script>
</body>
</html>